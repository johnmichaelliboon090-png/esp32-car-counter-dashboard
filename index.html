<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Parking Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #0d0f18;
    color: white;
    padding: 20px;
}

h1 {
    text-align: center;
    color: #00eaff;
    text-shadow: 0 0 15px #00eaff;
}

.grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
}

.card {
    background: #11141f;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 18px rgba(0, 238, 255, 0.3);
    border: 1px solid #00eaff60;
}

h2 {
    color: #00eaff;
    text-shadow: 0 0 10px #00eaff;
}

/* SLOT */
.slot {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0b1020;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: bold;
}

.free {
    background: #00ff88;
    color: #003320;
    box-shadow: 0 0 10px #00ff88;
}

.occupied {
    background: #ff4444;
    color: #330000;
    box-shadow: 0 0 10px #ff4444;
}

/* HISTORY TABLE */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #00eaff50;
    padding: 8px;
    text-align: center;
}

th {
    background: #00eaff20;
}
</style>
</head>

<body>

<h1>ðŸš— Smart Parking Dashboard</h1>

<div class="grid">

    <!-- TOTAL -->
    <div class="card">
        <h2>Total Cars Inside</h2>
        <h1 id="totalCars" style="text-align:center;font-size:48px;">0</h1>
    </div>

    <!-- SLOT STATUS -->
    <div class="card">
        <h2>Slot Status</h2>

        <div class="slot"><span>Slot 1</span><span id="slot1" class="badge">Loading...</span></div>
        <div class="slot"><span>Slot 2</span><span id="slot2" class="badge">Loading...</span></div>
        <div class="slot"><span>Slot 3</span><span id="slot3" class="badge">Loading...</span></div>
        <div class="slot"><span>Slot 4</span><span id="slot4" class="badge">Loading...</span></div>
    </div>

    <!-- GRAPH -->
    <div class="card">
        <h2>Real-Time Car Count</h2>
        <canvas id="carChart"></canvas>
    </div>

    <!-- HISTORY -->
    <div class="card" style="grid-column: span 2;">
        <h2>Parking History</h2>
        <table>
            <thead>
                <tr>
                    <th>Slot</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="historyTable"></tbody>
        </table>
    </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

<script>
// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "AIzaSyBf1PpD2Td4gE0hXR_iBdz2Iv_kbiGV7Zo",
  authDomain: "parkinglot-faed9.firebaseapp.com",
  databaseURL: "https://parkinglot-faed9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "parkinglot-faed9",
  storageBucket: "parkinglot-faed9.firebasestorage.app",
  messagingSenderId: "1045359755272",
  appId: "1:1045359755272:web:cf2263fe90db41b98c91bd"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// UI
const slots = [
  document.getElementById("slot1"),
  document.getElementById("slot2"),
  document.getElementById("slot3"),
  document.getElementById("slot4")
];
const totalCars = document.getElementById("totalCars");
const historyTable = document.getElementById("historyTable");

let previousStatus = ["", "", "", ""];

// ---------------- SLOT LISTENERS ----------------
for (let i = 1; i <= 4; i++) {
  db.ref(`/Parking/Sensor${i}/status`).on("value", snap => {
    const status = snap.val() || "Free";
    const badge = slots[i-1];

    badge.textContent = status;
    badge.className = "badge " + (status === "Occupied" ? "occupied" : "free");

    if (previousStatus[i-1] !== status) {
        addHistory(i, status);
        previousStatus[i-1] = status;
    }

    updateTotal();
  });
}

// ---------------- TOTAL COUNT ----------------
function updateTotal() {
  let count = 0;
  slots.forEach(b => {
    if (b.textContent === "Occupied") count++;
  });
  totalCars.textContent = count;
  updateGraph(count);
}

// ---------------- HISTORY ----------------
function addHistory(slot, status) {
  const now = new Date();
  const row = `
    <tr>
      <td>${slot}</td>
      <td>${status}</td>
      <td>${now.toLocaleDateString()}</td>
      <td>${now.toLocaleTimeString()}</td>
    </tr>
  `;
  historyTable.innerHTML = row + historyTable.innerHTML;

  if (historyTable.rows.length > 20) {
    historyTable.deleteRow(20);
  }
}

// ---------------- GRAPH ----------------
const ctx = document.getElementById("carChart").getContext("2d");
const carChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      label: "Cars Inside",
      data: [],
      borderColor: "#00eaff",
      borderWidth: 3,
      tension: 0.3
    }]
  },
  options: {
    scales: { y: { beginAtZero: true, stepSize: 1 } }
  }
});

function updateGraph(value) {
  if (carChart.data.labels.length > 20) {
    carChart.data.labels.shift();
    carChart.data.datasets[0].data.shift();
  }
  carChart.data.labels.push(new Date().toLocaleTimeString());
  carChart.data.datasets[0].data.push(value);
  carChart.update();
}
</script>

</body>
</html>
